<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GracePrint Studio | EPUB Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Patrick+Hand&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --bg-body: #fdfbf7; --card-bg: #ffffff; --primary: #9b99ff; --radius: 24px; }
        body { font-family: 'Nunito', sans-serif; background-color: var(--bg-body); padding: 40px 20px; text-align: center; }
        .container { max-width: 900px; margin: auto; background: var(--card-bg); padding: 40px; border-radius: var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left; }
        textarea { width: 100%; height: 150px; border-radius: 15px; border: 2px solid #e2e8f0; font-family: 'Patrick Hand', cursive; font-size: 18px; padding: 10px; resize: none; }
        .actions { margin-top: 30px; display: flex; gap: 15px; justify-content: center; }
        button { padding: 15px 25px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; color: white; }
        .btn-gen { background: #6c5ce7; } .btn-pdf { background: #ff7675; } .btn-epub { background: #00cec9; }
        #preview { margin-top: 30px; display: flex; gap: 10px; overflow-x: auto; padding: 20px; background: #eee; border-radius: 15px; }
        #preview img { height: 200px; border: 2px solid white; box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸŽ¨ GracePrint Studio</h1>
    <p>Generador de Cuentos (Hoja Individual)</p>
    
    <div class="grid">
        <div>
            <label><b>1. ImÃ¡genes (Portada + Interiores)</b></label><br><br>
            <input type="file" id="images" multiple accept="image/*">
            <br><br>
            <label><b>2. Fondo de Texto (Opcional)</b></label><br><br>
            <input type="file" id="template" accept="image/*">
        </div>
        <div>
            <label><b>3. Historia (Un pÃ¡rrafo por pÃ¡gina)</b></label><br><br>
            <textarea id="storyText" placeholder="Escribe aquÃ­..."></textarea>
        </div>
    </div>

    <div class="actions">
        <button class="btn-gen" onclick="generar()">âœ¨ Crear Magia</button>
        <button class="btn-pdf" onclick="exportarPDF()">ðŸ“„ PDF</button>
        <button class="btn-epub" onclick="exportarEPUB()">ðŸ“± EPUB</button>
    </div>

    <div id="preview"></div>
</div>

<script>
let paginasData = [];

function loadImg(f) { return new Promise(res => { const i = new Image(); i.onload = () => res(i); i.src = URL.createObjectURL(f); }); }

async function generar() {
    const imgFiles = document.getElementById('images').files;
    const tplFile = document.getElementById('template').files[0];
    const parrafos = document.getElementById('storyText').value.split('\n').filter(p => p.trim() !== "");
    const preview = document.getElementById('preview');

    if (imgFiles.length < 1) return alert("Sube al menos una imagen.");
    
    paginasData = [];
    preview.innerHTML = "";
    const tplImg = tplFile ? await loadImg(tplFile) : null;

    for (let i = 0; i < imgFiles.length; i++) {
        const currentImg = await loadImg(imgFiles[i]);
        const h = 1200; 

        // PÃ¡gina de Imagen
        const c1 = document.createElement('canvas');
        const ctx1 = c1.getContext('2d');
        c1.width = (currentImg.width * h) / currentImg.height;
        c1.height = h;
        ctx1.drawImage(currentImg, 0, 0, c1.width, h);
        paginasData.push({ url: c1.toDataURL('image/jpeg', 0.8), w: c1.width, h: h });

        // PÃ¡gina de Texto (si corresponde)
        if (i < imgFiles.length - 1 && parrafos[i]) {
            const c2 = document.createElement('canvas');
            const ctx2 = c2.getContext('2d');
            const rw = tplImg ? (tplImg.width * h) / tplImg.height : 900;
            c2.width = rw; c2.height = h;

            if (tplImg) ctx2.drawImage(tplImg, 0, 0, rw, h);
            else { ctx2.fillStyle = "#fff"; ctx2.fillRect(0,0,rw,h); }

            const texto = parrafos[i];
            ctx2.fillStyle = "#e17055";
            ctx2.font = "bold 150px 'Patrick Hand', cursive";
            const cap = texto.charAt(0).toUpperCase();
            ctx2.fillText(cap, rw * 0.15, 300);
            
            ctx2.fillStyle = "#2d3436";
            ctx2.font = "50px 'Patrick Hand', cursive";
            // Dibujado simple de texto (puedes mejorar el wrap si gustas)
            ctx2.fillText(texto.slice(1, 40) + "...", rw * 0.15, 450);

            paginasData.push({ url: c2.toDataURL('image/jpeg', 0.8), w: rw, h: h });
        }
    }

    paginasData.forEach(p => {
        const img = document.createElement('img');
        img.src = p.url;
        preview.appendChild(img);
    });
}

async function exportarEPUB() {
    if (!paginasData.length) return alert("Genera el cuento primero");
    
    const zip = new JSZip();
    const uid = "graceprint-" + Date.now();

    // 1. MIMETYPE (Debe ser el primero y sin comprimir)
    zip.file("mimetype", "application/epub+zip", { compression: "STORE" });

    // 2. META-INF
    zip.folder("META-INF").file("container.xml", `<?xml version="1.0"?><container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container"><rootfiles><rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/></rootfiles></container>`);

    // 3. OEBPS
    const oebps = zip.folder("OEBPS");
    const imgs = oebps.folder("images");
    let manifest = ""; let spine = ""; let nav = "";

    for (let i = 0; i < paginasData.length; i++) {
        const imgData = paginasData[i].url.split(',')[1];
        imgs.file(`f${i}.jpg`, imgData, {base64: true});

        const html = `<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml">
<head><title>P${i}</title><meta name="viewport" content="width=${paginasData[i].w},height=${paginasData[i].h}"/></head>
<body style="margin:0;background:#fff;"><img src="images/f${i}.jpg" style="width:100%;height:100%"/></body></html>`;
        
        oebps.file(`p${i}.xhtml`, html);
        manifest += `<item id="i${i}" href="images/f${i}.jpg" media-type="image/jpeg"/><item id="p${i}" href="p${i}.xhtml" media-type="application/xhtml+xml"/>`;
        spine += `<itemref idref="p${i}"/>`;
        nav += `<li><a href="p${i}.xhtml">PÃ¡gina ${i+1}</a></li>`;
    }

    // NavegaciÃ³n (Indispensable para que no de error)
    oebps.file("nav.xhtml", `<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops"><head><title>Nav</title></head>
<body><nav epub:type="toc"><h1>Tabla de Contenidos</h1><ol>${nav}</ol></nav></body></html>`);

    manifest += `<item id="nav" href="nav.xhtml" media-type="application/xhtml+xml" properties="nav"/>`;

    // OPF
    oebps.file("content.opf", `<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" version="3.0" unique-identifier="id">
<metadata xmlns:dc="http://purl.org/dc/elements/1.1/"><dc:title>Cuento GracePrint</dc:title><dc:language>es</dc:language><dc:identifier id="id">${uid}</dc:identifier><meta property="rendition:layout">pre-paginated</meta></metadata>
<manifest>${manifest}</manifest><spine>${spine}</spine></package>`);

    const blob = await zip.generateAsync({type: "blob", mimeType: "application/epub+zip"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "GracePrint_Libro.epub"; a.click();
}

function exportarPDF() { /* Mantener igual que el anterior */ }
</script>
</body>
</html>
