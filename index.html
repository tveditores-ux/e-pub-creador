<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GracePrint Studio | Hoja Individual</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Patrick+Hand&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        :root {
            --bg-body: #fdfbf7;
            --card-bg: #ffffff;
            --text-main: #5e6c84;
            --primary: #9b99ff;
            --secondary: #94d3ac;
            --accent: #ffb7b2;
            --shadow: 0 10px 30px rgba(154, 160, 185, 0.15);
            --radius: 24px;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            background-image: radial-gradient(#e0e7ff 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .container {
            max-width: 950px;
            margin: auto;
            background: var(--card-bg);
            padding: 50px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid white;
        }

        h1 { text-align: center; color: #6c5ce7; font-size: 2.5rem; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #a29bfe; margin-bottom: 40px; font-weight: 600; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .panel { background: #f8f9fa; padding: 25px; border-radius: 18px; border: 2px dashed #e2e8f0; }
        
        textarea {
            width: 100%; height: 160px; padding: 15px; border-radius: 15px;
            border: 2px solid #e2e8f0; font-family: 'Patrick Hand', cursive;
            font-size: 20px; box-sizing: border-box; resize: none; outline: none;
        }

        .actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 40px; }
        
        button {
            padding: 18px; border: none; border-radius: 16px; font-weight: 800;
            cursor: pointer; color: white; transition: all 0.2s;
        }

        .btn-gen { background: linear-gradient(135deg, #a29bfe, #6c5ce7); }
        .btn-pdf { background: linear-gradient(135deg, #ffb7b2, #ff7675); }
        .btn-epub { background: linear-gradient(135deg, #81ecec, #00cec9); }

        #preview {
            margin-top: 50px; background: #dfe6e9; padding: 30px; border-radius: 20px;
            display: flex; gap: 20px; overflow-x: auto; border-bottom: 6px solid #b2bec3;
        }

        #preview img { height: 240px; border-radius: 5px; box-shadow: 3px 5px 15px rgba(0,0,0,0.2); background: white; }
    </style>
</head>
<body>

<div class="container">
    <h1>üé® GracePrint Studio</h1>
    <p class="subtitle">Exportaci√≥n de Hoja Individual para EPUB</p>
    
    <div class="grid">
        <div class="panel">
            <label>üìö 1. Tus Ilustraciones</label>
            <input type="file" id="images" multiple accept="image/*">
            <label style="margin-top:20px;">üñºÔ∏è 2. Papel Decorativo</label>
            <input type="file" id="template" accept="image/*">
        </div>
        <div class="panel">
            <label>‚úçÔ∏è 3. La Historia</label>
            <textarea id="storyText" placeholder="Escribe un p√°rrafo por cada p√°gina interior..."></textarea>
        </div>
    </div>

    <div class="actions">
        <button class="btn-gen" onclick="generar()">‚ú® Crear Magia</button>
        <button class="btn-pdf" onclick="exportarPDF()">üìÑ Guardar PDF</button>
        <button class="btn-epub" onclick="exportarEPUB()">üì± Guardar eBook</button>
    </div>

    <div id="preview"></div>
</div>

<script>
let paginasData = [];

async function generar() {
    const imgFiles = document.getElementById('images').files;
    const tplFile = document.getElementById('template').files[0];
    const parrafos = document.getElementById('storyText').value.split('\n').filter(p => p.trim() !== "");
    const preview = document.getElementById('preview');

    if (imgFiles.length < 2) return alert("Selecciona al menos 2 im√°genes.");
    
    paginasData = [];
    preview.innerHTML = "";
    const tplImg = tplFile ? await loadImg(tplFile) : null;
    const btnGen = document.querySelector('.btn-gen');
    btnGen.textContent = "‚è≥ Procesando...";

    for (let i = 0; i < imgFiles.length; i++) {
        const currentImg = await loadImg(imgFiles[i]);
        const h = 1400; 

        // 1. GENERAR HOJA DE IMAGEN
        const canvasImg = document.createElement('canvas');
        const ctxImg = canvasImg.getContext('2d');
        canvasImg.width = (currentImg.width * h) / currentImg.height;
        canvasImg.height = h;
        ctxImg.drawImage(currentImg, 0, 0, canvasImg.width, h);
        
        paginasData.push({ url: canvasImg.toDataURL('image/jpeg', 0.8), w: canvasImg.width, h: h });

        // 2. GENERAR HOJA DE TEXTO (Solo si hay texto y no es la portada)
        if (i < imgFiles.length - 1 && parrafos[i]) {
            const canvasTxt = document.createElement('canvas');
            const ctxTxt = canvasTxt.getContext('2d');
            const rw = tplImg ? (tplImg.width * h) / tplImg.height : 1000;
            canvasTxt.width = rw;
            canvasTxt.height = h;

            if (tplImg) ctxTxt.drawImage(tplImg, 0, 0, rw, h);
            else { ctxTxt.fillStyle = "#fff"; ctxTxt.fillRect(0,0,rw,h); }

            const texto = parrafos[i];
            const mx = rw * 0.15;
            
            // Letra Capital
            ctxTxt.fillStyle = "#e17055";
            ctxTxt.font = "bold 180px 'Patrick Hand', cursive";
            const cap = texto.charAt(0).toUpperCase();
            const capW = ctxTxt.measureText(cap).width + 30;
            ctxTxt.fillText(cap, mx, 350);
            
            // Cuerpo
            ctxTxt.fillStyle = "#2d3436";
            ctxTxt.font = "60px 'Patrick Hand', cursive";
            wrapText(ctxTxt, texto.slice(1), mx, 280, rw * 0.7, 75, capW, 2);

            paginasData.push({ url: canvasTxt.toDataURL('image/jpeg', 0.8), w: rw, h: h });
        }
    }

    paginasData.forEach(p => {
        const img = document.createElement('img');
        img.src = p.url;
        preview.appendChild(img);
    });
    btnGen.textContent = "‚ú® Crear Magia";
}

function wrapText(ctx, text, x, y, maxWidth, lineHeight, gapWidth, linesWithGap) {
    const words = text.split(' ');
    let line = ''; let curL = 1; let curY = y;
    for (let n = 0; n < words.length; n++) {
        let test = line + words[n] + ' ';
        let cx = (curL <= linesWithGap) ? (x + gapWidth) : x;
        let cw = (curL <= linesWithGap) ? (maxWidth - gapWidth) : maxWidth;
        if (ctx.measureText(test).width > cw && n > 0) {
            ctx.fillText(line, cx, curY);
            line = words[n] + ' '; curY += lineHeight; curL++;
        } else { line = test; }
    }
    ctx.fillText(line, (curL <= linesWithGap ? x + gapWidth : x), curY);
}

function loadImg(f) { return new Promise(res => { const i = new Image(); i.onload = () => res(i); i.src = URL.createObjectURL(f); }); }

function exportarPDF() {
    if(!paginasData.length) return;
    const pdf = new jspdf.jsPDF({ orientation: 'l', unit: 'px' });
    paginasData.forEach((p, i) => {
        if (i > 0) pdf.addPage([p.w, p.h], p.w > p.h ? 'l' : 'p');
        else { pdf.deletePage(1); pdf.addPage([p.w, p.h], p.w > p.h ? 'l' : 'p'); }
        pdf.addImage(p.url, 'JPEG', 0, 0, p.w, p.h);
    });
    pdf.save("GracePrint_Cuento.pdf");
}

async function exportarEPUB() {
    if (!paginasData.length) return;
    const zip = new JSZip();
    zip.file("mimetype", "application/epub+zip", { compression: "STORE" });
    const oebps = zip.folder("OEBPS");
    const images = oebps.folder("images");
    let manifest = ""; let spine = "";

    for (let i = 0; i < paginasData.length; i++) {
        images.file(`i${i}.jpg`, paginasData[i].url.split(',')[1], {base64: true});
        oebps.file(`p${i}.xhtml`, `<html><head><meta name="viewport" content="width=${paginasData[i].w},height=${paginasData[i].h}"/></head><body style="margin:0"><img src="images/i${i}.jpg" style="width:100%"/></body></html>`);
        manifest += `<item id="i${i}" href="images/i${i}.jpg" media-type="image/jpeg"/><item id="p${i}" href="p${i}.xhtml" media-type="application/xhtml+xml"/>`;
        spine += `<itemref idref="p${i}"/>`;
    }
    
    oebps.file("content.opf", `<?xml version="1.0"?><package xmlns="http://www.idpf.org/2007/opf" version="3.0" unique-identifier="u"><metadata xmlns:dc="http://purl.org/dc/elements/1.1/"><dc:title>Cuento GracePrint</dc:title><dc:language>es</dc:language><meta property="rendition:layout">pre-paginated</meta></metadata><manifest>${manifest}</manifest><spine>${spine}</spine></package>`);
    zip.folder("META-INF").file("container.xml", `<?xml version="1.0"?><container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container"><rootfiles><rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/></rootfiles></container>`);

    const content = await zip.generateAsync({type:"blob"});
    const a = document.createElement('a'); a.href = URL.createObjectURL(content); a.download = "GracePrint_Libro.epub"; a.click();
}
</script>
</body>
</html>
